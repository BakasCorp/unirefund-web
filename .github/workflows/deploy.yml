name: Deploy Unirefund Apps
run-name: >
  üöÄ ${{ github.actor }} is deploying [${{ github.event.inputs.env }}]
  Unirefund-${{ github.event.inputs.app }}

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Release type (one of): uat, dev, prod"
        required: true
        default: "uat"
        type: choice
        options:
          - uat
          - dev
          - prod
      app:
        description: "App to publish (one of): ssr, web"
        required: true
        default: "ssr"
        type: choice
        options:
          - ssr
          - web

jobs:
  publish:
    runs-on: self-hosted
    timeout-minutes: 60
    environment: ${{ github.event.inputs.env }} # Connect to GitHub Environment
    steps:
      - name: Show context
        run: |
          echo "üéâ Triggered by: ${{ github.event_name }}"
          echo "üñ•Ô∏è  Running on: ${{ runner.os }}"
          echo "üåç Environment: ${{ github.event.inputs.env }}"
          echo "üì¶ App: ${{ github.event.inputs.app }}"

      - name: Set PORT from environment
        run: |
          if [[ "${{ github.event.inputs.app }}" == "web" ]]; then
            echo "PORT=${{ env.WEB_PORT }}" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.app }}" == "ssr" ]]; then
            echo "PORT=${{ env.SSR_PORT }}" >> $GITHUB_ENV
          else
            echo "‚ùå Invalid app type: ${{ github.event.inputs.app }}"
            exit 1
          fi

      - name: Run publish script
        run: |
          ssh ubuntu "
            cd ~/frontend/deployment/unirefund/${{ github.event.inputs.env }} &&
            npx -y @deployit/cli@latest deployit \
              --project Unirefund \
              --app ${{ github.event.inputs.app }} \
              --env ${{ github.event.inputs.env }} \
              --sync true \
              --port $PORT"
